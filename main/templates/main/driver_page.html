<!DOCTYPE html>
<html>
<head>
    <title>Driver View - {{ driver.name }}</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #f0f2f5; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
        .status { margin-top: 1rem; font-weight: bold; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .reload-btn { 
            display: none; margin-top: 1.5rem; padding: 10px 20px; 
            background: #2563eb; color: white; border: none; border-radius: 8px; 
            cursor: pointer; font-weight: 600; 
        }
        .reload-btn:hover { background: #1d4ed8; }
    </style>
</head>
<body>
    <div class="card">
        <h1>Driver: {{ driver.name }}</h1>
        <div id="status" class="status">Connecting...</div>
        <div id="stats" style="margin-top: 10px;">
            <p>Sent updates: <span id="count">0</span></p>
            <p>Last Lat: <span id="last-lat">-</span></p>
            <p>Last Lon: <span id="last-lon">-</span></p>
        </div>
        <button id="reload-btn" class="reload-btn" onclick="window.location.reload()">Reload Page</button>
    </div>

    <script>
        const token = "{{ driver.token }}";
        const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const socket = new WebSocket(protocol + window.location.host + '/ws/location/' + token + '/');
        let updateCount = 0;

        socket.onopen = function() {
            document.getElementById('status').textContent = 'Connected & Sending Location';
            document.getElementById('status').className = 'status success';
            document.getElementById('reload-btn').style.display = 'none';
            
            // Send initial location
            sendLocation();
            
            // Send every 30 seconds
            setInterval(sendLocation, 30000);
        };

        socket.onclose = function() {
            document.getElementById('status').textContent = 'Disconnected';
            document.getElementById('status').className = 'status error';
            document.getElementById('reload-btn').style.display = 'inline-block';
        };

        function sendLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const data = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify(data));
                        updateCount++;
                        document.getElementById('count').textContent = updateCount;
                        document.getElementById('last-lat').textContent = data.latitude.toFixed(6);
                        document.getElementById('last-lon').textContent = data.longitude.toFixed(6);
                    }
                }, (error) => {
                    console.error('Geolocation error:', error);
                }, { enableHighAccuracy: true });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }
    </script>
</body>
</html>
