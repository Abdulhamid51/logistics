<!DOCTYPE html>
<html>
<head>
    <title>Driver View - {{ driver.name }}</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #f0f2f5; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
        .status { margin-top: 1rem; font-weight: bold; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
    </style>
</head>
<body>
    <div class="card">
        <h1>Driver: {{ driver.name }}</h1>
        <p>Token: <code>{{ driver.token }}</code></p>
        <div id="status" class="status">Connecting...</div>
        <div id="stats" style="margin-top: 10px;">
            <p>Sent updates: <span id="count">0</span></p>
            <p>Last Lat: <span id="last-lat">-</span></p>
            <p>Last Lon: <span id="last-lon">-</span></p>
        </div>
    </div>

    <script>
        const token = "{{ driver.token }}";
        const socket = new WebSocket('ws://' + window.location.host + '/ws/location/' + token + '/');
        let updateCount = 0;

        socket.onopen = function() {
            document.getElementById('status').textContent = 'Connected & Sending Location';
            document.getElementById('status').className = 'status success';
            
            // Send initial location
            sendLocation();
            
            // Send every 1 minute
            setInterval(sendLocation, 60000);
        };

        socket.onclose = function() {
            document.getElementById('status').textContent = 'Disconnected';
            document.getElementById('status').className = 'status error';
        };

        function sendLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const data = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                    socket.send(JSON.stringify(data));
                    
                    updateCount++;
                    document.getElementById('count').textContent = updateCount;
                    document.getElementById('last-lat').textContent = data.latitude.toFixed(6);
                    document.getElementById('last-lon').textContent = data.longitude.toFixed(6);
                    console.log('Location sent:', data);
                }, (error) => {
                    console.error('Geolocation error:', error);
                    // For demo purposes, if geolocation fails (e.g. localhost without SSL), send fake coordinates
                    const fakeData = {
                        latitude: 41.2995 + (Math.random() - 0.5) * 0.01,
                        longitude: 69.2401 + (Math.random() - 0.5) * 0.01
                    };
                    socket.send(JSON.stringify(fakeData));
                    updateCount++;
                    document.getElementById('count').textContent = updateCount;
                    document.getElementById('last-lat').textContent = fakeData.latitude.toFixed(6);
                    document.getElementById('last-lon').textContent = fakeData.longitude.toFixed(6);
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }
    </script>
</body>
</html>
